<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="affiliatedOrganMapper">

	<resultMap id="affiliatedOrganResult" type="affiliatedOrganDto">
		<id column="aff_no" property="affNo"/>
		<result column="aff_name" property="affName" />
		<result column="aff_location" property="affLocation" />
		<result column="latitude" property="latitude" />
		<result column="longitude" property="longitude" />
		<result column="major_no" property="majorNo" />
		<result column="major_name" property="majorNo" />
		<result column="aff_etc" property="affEtc" />
		<collection  resultMap="attachResult" property="attachList"/>
	</resultMap>
	
	<resultMap id="attachResult" type="AttachDto">
		<id column="file_no" property="fileNo"/>
		<result column="original_name" property="originalName"/>
		<result column="filesystem_name" property="filesystemName"/>
		<result column="file_path" property="filePath"/>
		<result column="upload_date" property="uploadDate"/>
		<result column="ref_no" property="refNo"/>
		<result column="ref_type" property="refType"/>
  </resultMap>
	
	<resultMap id="affReservaationResult" type="affReservationDto">
		<id column="aff_res_no" property="affResNo"/>
		<result column="aff_no" property="affNo" />
		<result column="aff_name" property="affNo" />
		<result column="mem_no" property="memNo" />
		<result column="major_name" property="majorNo" />
		<result column="major_name" property="memNo" />
		<result column="start_date" property="startDate" />
		<result column="end_date" property="endDate" />
		<result column="reason" property="reason" />
	</resultMap>

	<!-- 부속기관 목록관련 -->
	<select id="selectAffiliatedOrganListCount" resultType="_int">
		select
  				 count(*)
			from affiliated_organ
	</select>
	
	<select id="selectAffiliatedOrganList" resultMap="affiliatedOrganResult">
  	select
		    	aff_no
			  , aff_name
			  , aff_location
			  , major_name
		 from affiliated_organ
     join major using (major_no)
		order by aff_no asc
  </select>
  
  <select id="selectAffiliatedOrgan" resultMap="affiliatedOrganResult">
  	select
  				 aff_no
		  	 , aff_name
		  	 , aff_location
		  	 , major_name
		     , aff_etc
  		from affiliated_organ
    	join major using (major_no)
  	 where aff_no = #{affNo}
  	
  </select>
  
  <!-- 부속기관 예약관련 -->
  <insert id="insertAffiliatedOrganRes">
		insert
			into aff_reservation
			(	
				aff_res_no, aff_no, mem_no, start_date, end_date, reason
			)
			values
			(
				seq_aff_res_no.nextval, #{affNo}, #{memNo}, #{startDate}, #{endDate}, #{reason} 
			)
  </insert>
  
  <select id="selectAffiliatedOrganResListCount" resultType="_int">
		select
  				 count(*)
			from aff_reservation
	</select>

	<select id="selectAffiliatedOrganResList" resultMap="affReservaationResult">
  	select
				   aff_name
				 , aff_location
				 , major_name
				 , start_date
				 , end_date
				 , reason
		  from aff_reservation
		  join affiliated_organ using (aff_no)
		  join major using (major_no)
  </select>

	<!-- 부속기관 등록관련 -->
  <insert id="insertAffiliatedOrgan">
  	insert 
  		into affiliated_organ
  			 (
  				 aff_no, aff_name, major_no
  			 , aff_location, latitude, longitude, aff_etc
				 )
					values
	 	 		(	
			 	 	 seq_aff_no.nextval, #{affName}, #{majorNo}
			 	 , #{affLocation}, #{latitude}, #{longitude}, #{affEtc}
			 	 )
  </insert>
  <!-- 부속기관 사진 등록 -->
  <insert id="insertAttach">
		insert
			into board_attach
			(
				file_no
			, file_path
			, filesystem_name
			, original_name
			, ref_type
			, ref_no
			)
			values
			(
			  seq_board_file_no.nextval
			, #{filePath}
			, #{filesystemName}
			, #{originalName}
			, #{refType}
			, seq_aff_no.currval
			)
	</insert>
  
  

</mapper>
