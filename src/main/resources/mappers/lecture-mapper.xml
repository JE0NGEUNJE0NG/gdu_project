<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="lectureMapper">
	
	<resultMap id="stuAttendResult" type="stuAttendDto">
		<id column="attend_no" property="attendNo"/>
		<result column="stu_no" property="stuNo" />
		<result column="stu_name" property="stuName" />
		<result column="attendance" property="attendance" />
		<result column="lec_no" property="lecNo" />
		<result column="lecture_date" property="lectureDate" />
		<result column="major_no" property="majorNo" />
		<result column="major_name" property="majorName" />
		<result column="lec_name" property="lecName" />
		<collection  resultMap="attachResult" property="attachList"/>
	</resultMap>
	
	<resultMap id="lectureResult" type="lectureDto">
		<id column="lec_no" property="lecNo"/>
		<result column="mem_no" property="memNo" />
		<result column="major_no" property="majorNo" />
		<result column="lec_name" property="lecName" />
	</resultMap>
	
	<resultMap id="lecStuResult" type="lecStuDto">
		<id column="lecstu_no" property="lecstuNo"/>
		<result column="lec_no" property="lecNo" />
		<result column="stu_no" property="stuNo" />
		<result column="major_no" property="majorNo" />
		<result column="stu_name" property="stuName" />
		<result column="lec_name" property="lecName" />
		<result column="major_name" property="majorName" />
	</resultMap>
	
	<resultMap id="attachResult" type="AttachDto">
		<id column="file_no" property="fileNo"/>
		<result column="original_name" property="originalName"/>
		<result column="filesystem_name" property="filesystemName"/>
		<result column="file_path" property="filePath"/>
		<result column="upload_date" property="uploadDate"/>
		<result column="ref_no" property="refNo"/>
		<result column="ref_type" property="refType"/>
  </resultMap>
	
	<!-- 출석 관련 -->
	<select id="selectStuAttendListCount" resultType="int">
		select
  				 count(*)
			from lec_stu
	</select>
	
	<!-- 교수 강의목록 -->
	<select id="selectLectureList" resultMap="lectureResult">
		select
		lec_no
		,lec_name
		from lecture
		where mem_no=#{memNo}
	</select>
	
	<!-- 학생 출석목록 -->
	<select id="selectStuAttendList" resultMap="lecStuResult">
		select
		lecstu_no
		,lec_no
		, file_no
    , file_path
    , filesystem_name
    , original_name
		, major_name
		, major_no
		, stu_no
		, stu_name
			from lec_stu
			left join board_attach on (ref_type = 'S' and ref_no = lecstu_no)
			order by stu_no asc
	</select>

	<select id="selectStuListForLec" resultMap="lecStuResult">
		select  	
		 major_name
		, stu_no
		, stu_name
		, lec_no
		, major_no
		from lec_stu
		where lec_no=#{lecNo}
	</select>
	
	<!-- 학생 출석 목록 스케줄러 이용해서 등록 -->
	<insert id="insertStuList">
		insert 
			into stu_attend (atten_no, stu_no, lec_no, major_no, stu_name, major_name, lec_name)
		select seq_stu_attend_no.nextval, stu_no, lec_no, major_no, stu_name, major_name, lec_name
			from lec_stu
	</insert>
	
	<update id="updateStuAttend">
		update stu_attend
			 set attendance = #{attendance}
		 where stu_no =#{stuNo}
			 and lec_no =#{lecNo}
			 and to_char(lecture_date,'YY/MM/DD')=to_char(sysdate, 'YY/MM/DD')
	</update>
	
</mapper>
